############################
# PROTOCOL (MASTER ENTITY)
############################

type Protocol @entity(immutable: false) {
  id: ID! # "CAPX"
  totalUsers: BigInt!
  totalActiveStakers: BigInt!

  totalTransactions: BigInt!

  # Staking & vesting (raw + normalized)
  totalStakedRaw: BigInt!
  totalVestedRaw: BigInt!

  # Cached invariant: totalTVL = totalStaked + totalVested
  totalTVLRaw: BigInt!

  # Rewards
  totalRewardsDistributedRaw: BigInt!
  totalVestingClaimedRaw: BigInt!

  # Supply
  circulatingSupplyRaw: BigInt!
  totalBurnedRaw: BigInt!

  totalTreasuryFeeRaw: BigInt!
  totalTeamMintedRaw: BigInt!
  totalTreasuryMintedRaw: BigInt!
  totalDAOmintedRaw: BigInt!

  # APR/APY Configuration
  currentBaseAprBps: BigInt!
  flexMultiplierBps: BigInt!
  days30MultiplierBps: BigInt!
  days90MultiplierBps: BigInt!
  days180MultiplierBps: BigInt!
  minStakeAmount: BigInt!

  lastUpdateBlock: BigInt!
  lastUpdateTimestamp: BigInt!
}

############################
# TIME SERIES (DAY / WEEK / MONTH / YEAR)
############################

type DailyData @entity(immutable: false) {
  id: ID! # dayIndex
  timestamp: BigInt! # day start timestamp
  # Activity
  totalTransactions: BigInt!
  transferCount: BigInt!

  # Volume
  transferVolumeRaw: BigInt!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!
  netStakingFlowRaw: BigInt!

  # Rewards
  rewardsDistributedRaw: BigInt!

  # Users
  newUsers: BigInt!
  cumulativeUsers: BigInt!
  activeStakersCount: BigInt!

  # TVL
  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  # Treasury Balance (for Treasury Growth chart)
  # Calculated as: totalTreasuryFeeRaw + totalTreasuryMintedRaw
  treasuryBalanceRaw: BigInt!
}

type WeeklyData @entity(immutable: false) {
  id: ID! # weekIndex
  timestamp: BigInt! # week start timestamp
  totalTransactions: BigInt!
  transferCount: BigInt!

  transferVolumeRaw: BigInt!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!
  netStakingFlowRaw: BigInt!

  rewardsDistributedRaw: BigInt!

  newUsers: BigInt!
  cumulativeUsers: BigInt!
  activeStakersCount: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  treasuryBalanceRaw: BigInt!
}

type MonthlyData @entity(immutable: false) {
  id: ID! # monthIndex
  timestamp: BigInt! # month start
  totalTransactions: BigInt!
  transferCount: BigInt!
  transferVolumeRaw: BigInt!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!
  netStakingFlowRaw: BigInt!

  rewardsDistributedRaw: BigInt!

  newUsers: BigInt!
  cumulativeUsers: BigInt!
  activeStakersCount: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  treasuryBalanceRaw: BigInt!
}

type YearlyData @entity(immutable: false) {
  id: ID! # yearIndex
  timestamp: BigInt! # year start
  totalTransactions: BigInt!
  transferCount: BigInt!
  transferVolumeRaw: BigInt!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!
  netStakingFlowRaw: BigInt!

  rewardsDistributedRaw: BigInt!

  newUsers: BigInt!
  cumulativeUsers: BigInt!
  activeStakersCount: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  treasuryBalanceRaw: BigInt!
}

############################
# USERS
############################

type User @entity(immutable: false) {
  id: ID! # address hex
  address: Bytes!

  firstSeenBlock: BigInt
  firstSeenTimestamp: BigInt

  txCount: BigInt!
  lastActivityTimestamp: BigInt

  hasActiveStake: Boolean!
  totalStakedRaw: BigInt!
  totalUnstakedRaw: BigInt!

  totalRewardsClaimedRaw: BigInt!

  hasActiveVesting: Boolean!
  totalVestingAllocatedRaw: BigInt!
  totalVestingClaimedRaw: BigInt!

  stakingPositions: [StakingPosition!]! @derivedFrom(field: "user")

  vestingPositions: [VestingPosition!]! @derivedFrom(field: "user")
}

############################
# STAKING
############################

type StakingPosition @entity(immutable: false) {
  id: ID! # txHash-logIndex
  user: User!
  userAddress: Bytes!

  amountRaw: BigInt!

  lockOption: Int!
  unlockTime: BigInt

  active: Boolean!

  totalRewardsClaimedRaw: BigInt!

  stakedAt: BigInt!
  stakedAtBlock: BigInt!
  unstakedAt: BigInt
}

############################
# VESTING
############################

type VestingPosition @entity(immutable: false) {
  id: ID! # txHash-logIndex
  user: User
  beneficiary: Bytes!

  totalAllocatedRaw: BigInt!
  totalClaimedRaw: BigInt!

  startTime: BigInt!
  cliffEnd: BigInt
  endTime: BigInt!

  revoked: Boolean!
  active: Boolean!

  createdAt: BigInt!
  createdAtBlock: BigInt!
  revokedAt: BigInt
}

############################
# ROLES
############################

type RoleAccount @entity(immutable: false) {
  id: ID! # role-account
  role: String!
  account: Bytes!

  isActive: Boolean!
  assignedAtBlock: BigInt!
  assignedAtTimestamp: BigInt

  revokedAtBlock: BigInt
  revokedAtTimestamp: BigInt
}

############################
# TRANSACTIONS (LEAN)
############################

type Transaction @entity(immutable: true) {
  id: ID! # tx hash
  blockNumber: BigInt!
  timestamp: BigInt!
}
