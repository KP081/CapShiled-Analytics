############################
# PROTOCOL (MASTER ENTITY)
############################

type Protocol @entity(immutable: false) {
  id: ID! # "CAPX"
  totalUsers: BigInt!
  totalTransactions: BigInt!

  # Staking & vesting (raw + normalized)
  totalStakedRaw: BigInt!
  totalStaked: BigDecimal!

  totalVestedRaw: BigInt!
  totalVested: BigDecimal!

  # Cached invariant: totalTVL = totalStaked + totalVested
  totalTVLRaw: BigInt!
  totalTVL: BigDecimal!

  # Rewards
  totalRewardsDistributedRaw: BigInt!
  totalRewardsDistributed: BigDecimal!

  totalVestingAllocatedRaw: BigInt!
  totalVestingAllocated: BigDecimal!

  totalVestingClaimedRaw: BigInt!
  totalVestingClaimed: BigDecimal!

  # Supply
  circulatingSupplyRaw: BigInt!
  circulatingSupply: BigDecimal!

  totalBurnedRaw: BigInt!
  totalBurned: BigDecimal!

  totalTreasuryFeeRaw: BigInt!
  totalTreasuryFee: BigDecimal!

  totalTeamMintedRaw: BigInt!
  totalTeamMinted: BigDecimal!

  totalTreasuryMintedRaw: BigInt!
  totalTreasuryMinted: BigDecimal!

  totalDAOmintedRaw: BigInt!
  totalDAOminted: BigDecimal!

  lastUpdateBlock: BigInt!
  lastUpdateTimestamp: BigInt!
}

############################
# LOCK STATS (QUERY SEPARATELY)
############################

type LockStat @entity(immutable: false) {
  id: ID! # "lock-0", "lock-1", ...
  lockOption: Int! # 0=FLEX,1=30d,2=90d,3=180d
  activePositions: BigInt!

  totalLockedRaw: BigInt!
  totalLocked: BigDecimal!

  totalRewardsDistributedRaw: BigInt!
  totalRewardsDistributed: BigDecimal!
}

############################
# TIME SERIES (WEEK / MONTH / YEAR)
############################

type WeeklyData @entity(immutable: false) {
  id: ID! # weekIndex
  timestamp: BigInt!

  transferCount: BigInt!
  transferVolumeRaw: BigInt!
  transferVolume: BigDecimal!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!

  rewardsClaimedRaw: BigInt!
  rewardsClaimed: BigDecimal!

  newUsers: BigInt!
  cumulativeUsers: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  totalTransactions: BigInt!
}

type MonthlyData @entity(immutable: false) {
  id: ID! # monthIndex
  timestamp: BigInt!

  transferCount: BigInt!
  transferVolumeRaw: BigInt!
  transferVolume: BigDecimal!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!

  rewardsClaimedRaw: BigInt!
  rewardsClaimed: BigDecimal!

  newUsers: BigInt!
  cumulativeUsers: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  totalTransactions: BigInt!
}

type YearlyData @entity(immutable: false) {
  id: ID! # yearIndex
  timestamp: BigInt!

  transferCount: BigInt!
  transferVolumeRaw: BigInt!
  transferVolume: BigDecimal!

  stakingVolumeRaw: BigInt!
  unstakingVolumeRaw: BigInt!

  rewardsClaimedRaw: BigInt!
  rewardsClaimed: BigDecimal!

  newUsers: BigInt!
  cumulativeUsers: BigInt!

  tvlStartRaw: BigInt!
  tvlEndRaw: BigInt!
  tvlPeakRaw: BigInt!

  totalTransactions: BigInt!
}

############################
# USERS
############################

type User @entity(immutable: false) {
  id: ID! # address hex
  address: Bytes!

  firstSeenBlock: BigInt
  firstSeenTimestamp: BigInt

  txCount: BigInt!
  lastActivityTimestamp: BigInt

  hasActiveStake: Boolean!
  totalStakedRaw: BigInt!
  totalUnstakedRaw: BigInt!

  totalRewardsClaimedRaw: BigInt!
  totalRewardsClaimed: BigDecimal!

  hasActiveVesting: Boolean!
  totalVestingAllocatedRaw: BigInt!
  totalVestingClaimedRaw: BigInt!

  stakingPositions: [StakingPosition!]! @derivedFrom(field: "user")

  vestingPositions: [VestingPosition!]! @derivedFrom(field: "user")
}

############################
# STAKING
############################

type StakingPosition @entity(immutable: false) {
  id: ID! # txHash-logIndex
  user: User!
  userAddress: Bytes!

  amountRaw: BigInt!
  amount: BigDecimal!

  lockOption: Int!
  unlockTime: BigInt

  active: Boolean!

  totalRewardsClaimedRaw: BigInt!
  totalRewardsClaimed: BigDecimal!

  stakedAt: BigInt!
  stakedAtBlock: BigInt!
  unstakedAt: BigInt
}

############################
# VESTING
############################

type VestingPosition @entity(immutable: false) {
  id: ID! # txHash-logIndex
  user: User
  beneficiary: Bytes!

  totalAllocatedRaw: BigInt!
  totalClaimedRaw: BigInt!

  startTime: BigInt!
  cliffEnd: BigInt
  endTime: BigInt!

  revoked: Boolean!
  active: Boolean!

  createdAt: BigInt!
  createdAtBlock: BigInt!
  revokedAt: BigInt
}

############################
# ROLES
############################

type RoleAccount @entity(immutable: false) {
  id: ID! # role-account
  role: String!
  account: Bytes!

  isActive: Boolean!
  assignedAtBlock: BigInt!
  assignedAtTimestamp: BigInt

  revokedAtBlock: BigInt
  revokedAtTimestamp: BigInt
}

############################
# TRANSACTIONS (LEAN)
############################

type Transaction @entity(immutable: true) {
  id: ID! # tx hash
  blockNumber: BigInt!
  timestamp: BigInt!
}
